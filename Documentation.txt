The Dönerpricer - Grocery Price Tracker & Predictor
=====================================================

This grocery price tracker is a stand-alone Python application with a vintage newspaper-themed UI that helps users track grocery prices and predict optimal buying days using machine learning.

## Project Overview

The Dönerpricer is a comprehensive price tracking system that:
- Stores historical grocery purchase data in Supabase (cloud PostgreSQL database)
- Analyzes price trends using Ridge Regression machine learning
- Predicts the best day to buy products at optimal prices
- Visualizes price history and geographic distribution of purchases
- Features a distinctive vintage newspaper aesthetic

## Feasibility as Course Project

- **Fits course requirements**: Stand-alone Python app with clear GUI, data I/O (database integration), time-series visualization, and ML component for price prediction
- **Manageable scope**: Can track any number of items with historical data, showing meaningful trends and recommendations
- **Library integration**: Successfully uses Pandas, NumPy, scikit-learn, PySide6, Matplotlib, Leaflet maps, and Supabase

## Architecture & Tech Stack

### Core Technologies
- **GUI Framework**: PySide6 (Qt for Python)
- **Database**: Supabase (PostgreSQL) with Python SDK
- **Data Processing**: Pandas, NumPy
- **Machine Learning**: scikit-learn (Ridge Regression with cross-validation)
- **Visualization**: Matplotlib (embedded charts), Leaflet.js (interactive maps)
- **Styling**: QSS (Qt Style Sheets) for centralized design

### File Structure
```
Dönerpricer/
├── main.py              # Main application window and UI layout
├── database.py          # Supabase client & data operations (merged from supabase_client.py)
├── ml_model.py          # Ridge Regression prediction model
├── price_chart.py       # Matplotlib price history chart
├── map.py               # Leaflet-based interactive location map
├── style.qss            # Centralized styling (vintage newspaper theme)
├── fonts/               # Custom fonts (Noto Serif, Courier Prime, Playfair Display)
└── .env                 # Environment variables (Supabase credentials)
```

## UI Design - Vintage Newspaper Theme

The application features a distinctive vintage newspaper aesthetic inspired by early 20th-century print media:

### Design Elements
- **Typography**: 
  - Headlines: Noto Serif (bold, uppercase, large)
  - Body text: Lora serif font
  - Data displays: Courier Prime monospace
  - Special accents: Playfair Display for predictions
  
- **Color Scheme**:
  - Paper: #fdfbf7 (warm off-white)
  - Ink: #1a1a1a (deep black)
  - Monochrome map tiles with sepia filter
  
- **Layout Elements**:
  - Double-line borders (newspaper column separators)
  - Ornamental headers and badges
  - Structured panels mimicking newspaper sections

### UI Structure (Vertical Stack Layout)

1. **Masthead** (Newspaper Header)
   - Application title: "The Dönerprice"
   - Meta information: Volume, Edition, Price
   - Current date and location
   - Double-line separator borders

2. **Search Panel** ("Search Archives")
   - Product name dropdown (autocomplete, 500px width)
   - Brand filter dropdown (optional, 500px width)
   - Search button (300px width)
   - Triggers all data updates on button click only

3. **Recommendation Panel** ("Prediction")
   - Verdict badge: "Prediction" (newspaper-style label)
   - Recommendation header: "BUY IT NOW!" or "HOLD YOUR WALLET!"
   - Statistics grid:
     * Forecasted Price
     * Target Day (best day to buy)
   - Confidence Index (displayed as percentage)
   - Only shows recommendations with >90% confidence

4. **Recent Transactions Table**
   - Displays historical purchase data
   - Columns: Date, Price, Avg Price/g, Supermarket, Location
   - Record count displayed ("REC: X")
   - Sortable by clicking column headers
   - Minimum height: 200px

5. **Market Fluctuations Chart** ("Price History Analysis")
   - Matplotlib line chart embedded in Qt
   - Shows price trends over time
   - Vintage newspaper styling (sepia tones, serif fonts)
   - Minimum height: 200px

6. **Geographic Distribution Map** ("Supermarket Locations")
   - Interactive Leaflet.js map
   - Grayscale tiles with sepia filter
   - Custom markers (€ symbols) for purchase locations
   - Popup tooltips showing supermarket, location, and price
   - Geocoding for Münster, Germany locations

## How the Machine Learning Model Works

The ML model uses **Ridge Regression** to predict optimal buying days based on historical price patterns.

### 1. Model Choice: Ridge Regression

**Why Ridge Regression?**
- **Stability for small datasets**: Linear models are more reliable than neural networks when data is limited
- **Prevents overfitting**: L2 regularization (Ridge) penalizes extreme weight values
- **Automatic hyperparameter tuning**: RidgeCV uses cross-validation to find optimal regularization strength (alpha/λ)
- **Interpretable**: Can see which features (brand, location, day) most influence prices

**Mathematical Foundation**:
```
Loss_Total = MSE + λ × Σ(weights²)
```
- MSE measures prediction accuracy
- λ (lambda) prevents the model from over-adjusting to outliers
- Cross-validation tests multiple λ values [0.1, 1.0, 10.0] to find the best one

### 2. Feature Engineering

The model transforms raw data into meaningful numerical features:

**Temporal Features**:
- `day_of_week` (0-6): Captures weekly patterns (e.g., weekend price changes)
- `day_of_year` (1-365): Captures seasonal trends
- `month` (1-12): Monthly patterns

**Statistical Features**:
- `rolling_avg`: 7-day moving average price (trend indicator)
- `price_volatility`: 7-day price standard deviation (stability measure)

**Categorical Features** (One-Hot Encoded):
- `brand_name_*`: Binary columns for each brand
- `supermarket_*`: Binary columns for each store
- `location_*`: Binary columns for each location

**Product Attributes**:
- `weight_grams`: Product weight (for price normalization)

### 3. Training Process

**Every search triggers fresh model training**:
1. Load historical data for selected product
2. Apply feature engineering
3. Scale features using StandardScaler (z = (x - μ) / σ)
4. Train RidgeCV with 5-fold cross-validation
5. RidgeCV automatically selects best alpha value

**Why train on every search?**
- Each product has unique price patterns
- Recent data might change predictions
- Minimal computational cost (Ridge is fast)

### 4. Prediction Process

1. **Generate future features**: Create feature vectors for next 7 days
2. **Scale features**: Use same scaler from training
3. **Predict prices**: Model outputs price for each day
4. **Select best day**: Choose day with lowest predicted price
5. **Calculate confidence**: Based on historical price volatility
   - Low volatility → High confidence
   - High volatility → Low confidence

### 5. Output & Recommendations

**Recommendation Display**:
- **Best Day**: Day of week with lowest predicted price
- **Expected Price**: Predicted price for that day
- **Confidence Index**: Percentage based on price stability

**Decision Logic**:
- If confidence < 90%: "Confidence too low for reliable recommendation"
- If best day is today: "BUY IT NOW!"
- If best day is future (not today): "HOLD YOUR WALLET!"

### 6. Model Reproducibility

**Deterministic Behavior**:
- Fixed random seed (`np.random.seed(42)`) ensures consistent results
- Same input data → Same predictions every time
- Critical for testing and validation

## Database Schema (Supabase)

**Table**: `receipts`

| Column          | Type    | Description                    |
|----------------|---------|--------------------------------|
| id             | int8    | Primary key (auto-increment)   |
| item_name      | text    | Product name                   |
| purchase_date  | date    | Date of purchase               |
| weekday        | int2    | Day of week (0-6)              |
| price_eur      | float4  | Price in euros                 |
| supermarket    | text    | Store name (REWE, Lidl, Aldi)  |
| location       | text    | Store location                 |
| brand_name     | text    | Product brand (nullable)       |
| weight_grams   | float4  | Product weight (nullable)      |

## Key Features

1. **Centralized Styling**: All visual design in `style.qss`, easy to modify theme
2. **Interactive Map**: Geocoded locations with custom markers and popups
3. **Smart Search**: Only updates on button click (not dropdown selection)
4. **Dynamic UI**: Recommendation text changes based on confidence and timing
5. **Data Validation**: Handles missing values, categorical encoding, feature scaling
6. **Professional ML**: Uses scikit-learn best practices (CV, regularization, scaling)

## Future Enhancements

- Receipt image upload with OCR (OpenCV/Pillow)
- Price prediction chart showing 7-day forecast
- More sophisticated confidence metrics
- Export recommendations to PDF/CSV
- Multi-item comparison view
- Price alerts and notifications

## Dependencies

```
PySide6              # Qt GUI framework
pandas               # Data manipulation
numpy                # Numerical operations
scikit-learn         # Machine learning (Ridge Regression, StandardScaler)
supabase             # Database SDK
python-dotenv        # Environment variable management
matplotlib           # Chart visualization
```

## Environment Setup

Required `.env` file:
```
SUPABASE_URL=your_supabase_project_url
SUPABASE_KEY=your_supabase_anon_key
```

## Code Refactoring (December 2025)

Recent improvements to codebase organization:
1. **Merged** `supabase_client.py` into `database.py` (eliminated redundant file)
2. **Consolidated** geocoding data to class-level in `map.py` (easier maintenance)
3. **Extracted** all font styles and widget sizes from Python to QSS (centralized styling)
4. **Fixed** search trigger to button-only (removed dropdown auto-search)

